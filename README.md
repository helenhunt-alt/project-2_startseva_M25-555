# Primitive DB

Учебный проект: консольное приложение — примитивная база данных.  

Реализует базовые операции управления таблицами и хранит метаданные в JSON-файле.  
Проект разработан в рамках учебного задания.

---

## Описание проекта

Программа представляет собой простую файловую базу данных с возможностью:  

- создания таблиц;  
- просмотра списка таблиц;  
- удаления таблиц;  
- работы с записями (добавление, выборка, обновление, удаление).  

Информация о таблицах (имена и структура столбцов) хранится в `db_meta.json`.  
Работа с базой данных осуществляется через интерактивный консольный интерфейс.
> Папка data/ создается автоматически при первом запуске программы и хранит файлы с метаданными и данными таблиц.

---

## Поддерживаемые типы данных

- `int`  
- `str`  
- `bool`  

---

## Управление таблицами

После запуска программы пользователь попадает в интерактивный режим.  

### Команды:

- `create_table <имя_таблицы> <столбец1:тип> <столбец2:тип> ...` — создать таблицу.  
  Особенности:  
  - Если столбец `ID:int` не указан пользователем, он добавляется автоматически.  
  - `ID` является уникальным ключом и всегда первым столбцом таблицы.  
  - Если таблица с таким именем уже существует, создание невозможно.  

  **Пример:**
```bash
  create_table users name:str age:int is_active:bool
```

- `list_tables` — показать список всех таблиц.  
  **Пример:**
```bash
  list_tables
  users
  products
```

- `drop_table <имя_таблицы>` — удалить таблицу.  
  Перед удалением пользователю задается вопрос подтверждения (работа декоратора `confirm_action`).  
  **Пример:**
```bash
  drop_table users
  Вы уверены, что хотите выполнить "удаление таблицы"? [y/n]: n
  Операция "удаление таблицы" отменена.
```
  
  Если таблица не существует, выводится сообщение об ошибке.  

  - `exit` — выход из программы.  
  - `help` — справочная информация.

---

## Работа с записями

- `insert` — добавление записи в таблицу.  
- `select` — выборка записей с возможностью фильтрации.  
Кэширование результатов реализовано через замыкание `create_cacher`.  
При повторных запросах результаты берутся из кэша.
- `update` — обновление существующих записей по условию.  
- `delete` — удаление записей по условию.  
Перед удалением выводится запрос подтверждения (`confirm_action`).

> Все операции поддерживают обработку ошибок (`handle_db_errors`) и выводят информативные сообщения пользователю.

---

## Обработка ошибок и улучшение кода

Для повышения качества кода использованы **декораторы** и **замыкания**:

1. **Декоратор `handle_db_errors`**  
 - Централизует обработку ошибок (`KeyError`, `ValueError`, `FileNotFoundError` и др.).  
 - Позволяет убрать дублирующиеся блоки `try...except` в функциях.  

2. **Декоратор `confirm_action(action_name)`**  
 - Запрашивает у пользователя подтверждение перед опасными операциями (удаление таблицы или записей).  
 - Пример:
   ```python
   @confirm_action("удаление таблицы")
   def drop_table(metadata, table_name):
       ...
   ```

3. **Декоратор `log_time`**  
 - Замеряет время выполнения функции и выводит его в консоль.  
 - Применяется к медленным операциям (`insert`, `select`).  

4. **Функция с замыканием `create_cacher`**  
 - Реализует кэширование результатов `select`.  
 - При повторных запросах возвращает данные из кэша, ускоряя работу программы.

---

## Установка и запуск

### Требования

- Python 3.10+  
- Poetry  

### Установка зависимостей
```bash
make install
```
Выполняет poetry install и устанавливает все зависимости.

### Сборка пакета
```bash
make build
```
Собирает пакет в формате .whl и .tar.gz в папку dist/.

### Установка пакета
```bash
make package-install
```
Устанавливает собранный пакет из dist/ через pip.

### Запуск программы
После установки пакета доступны два варианта запуска:

1. Через Makefile:
```bash
make project
```
2. Через установленный пакет напрямую:
```bash
database
```

### Демонстрация работы базы данных
Пример работы через Asciinema (демонстрация декораторов):
```bash
$ database
Введите команду: create_table users name:str age:int is_active:bool
Таблица "users" успешно создана со столбцами: ID:int, name:str, age:int, is_active:bool

Введите команду: insert into users values (Alice, 30, true)
Запись с ID=1 успешно добавлена в таблицу "users".
Функция insert выполнилась за 0.000 секунд.

Введите команду: select from users
Функция select выполнилась за 0.000 секунд.

Введите команду: select from users
Функция select выполнилась за 0.000 секунд.

Введите команду: delete from users where name = Alice
Вы уверены, что хотите выполнить "удаление записей"? [y/n]: n
Операция "удаление записей" отменена.

Введите команду: drop_table users
Вы уверены, что хотите выполнить "удаление таблицы"? [y/n]: y
Таблица "users" успешно удалена.
```

### Демонстрация работы базы данных

[![asciicast](https://asciinema.org/a/HabSxaypqDUkDXQK.svg)](https://asciinema.org/a/HabSxaypqDUkDXQK)

### Демонстрация работы декораторов

[![asciicast](https://asciinema.org/a/FslvLutBAafaX1hf.svg)](https://asciinema.org/a/FslvLutBAafaX1hf)

### Структура проекта
```bash
├── src/
│   ├── primitive_db/
│   │   ├── __init__.py
│   │   ├── constants.py
│   │   ├── core.py
│   │   ├── decorators.py
│   │   ├── engine.py
│   │   ├── main.py
│   │   ├── parser.py
│   │   └── utils.py
│   └── __init__.py
├── .gitignore
├── Makefile
├── poetry.lock
├── pyproject.toml
└── README.md
```

### Примечания
- Проект является учебным и не предназначен для промышленного использования.
- Хранение данных реализовано в упрощённом виде для демонстрации принципов работы.